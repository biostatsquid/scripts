---
title: "Granuloma spatial transcriptomics data summary"
graphics: yes
header-includes:
  \usepackage{graphicx, fancyhdr, multicol, xcolor}
  \usepackage{sectsty, titling, lmodern}
  \usepackage{float, wrapfig}
  \usepackage{hyperref}
  \usepackage[T1]{fontenc}
  \usepackage[labelfont=bf]{caption}
  \captionsetup{labelfont=bf}
  \renewcommand*\familydefault{\sfdefault}
  \definecolor{myblue}{RGB}{31, 120, 180}
  \allsectionsfont{\color{myblue}}
  \sectionfont{\color{myblue}\sectionrule{3ex}{0pt}{-1ex}{1pt}}
  \renewcommand{\maketitlehookb}{\raggedright \\ \vspace{1em}}
  \pretitle{\begin{center}\LARGE\bfseries\color{myblue}}
  \posttitle{\par\end{center}\vskip 0.5em}
  \pagestyle{fancy}
  \lhead{Ines Assum}
  \rhead{\today}
  \chead{Granuloma spatial transcriptomics data summary}
output: 
  pdf_document:
    toc: FALSE
    number_sections: FALSE
    keep_tex: TRUE
---

\setcounter{table}{0}
\setcounter{figure}{0}

```{r setup, include=FALSE}
options(width = 90)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(cache = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(fig.align = "center")
```

```{r, echo=F, eval=F}
setwd("/Users/mendenlab/work/spatial_granuloma/scripts/summary")
getwd()
library(ggplot2)
library(RColorBrewer)
library(patchwork)
library(dplyr)
library(anndata)
library(reticulate)
library(hdf5r)

local=T
HMGU.blue <- "#003E6E"
mygray <- "#C6DDEA"
myred <- "#C01514"
col.paired <- brewer.pal(n = 12, "Paired")
col.accent <- brewer.pal(n = 8, "Accent")
col.set1 <- col.paired[c(2,9,8)]
col.set2 <- col.paired[c(9,5,7,3,8,2)]
col.set3 <- brewer.pal(n = 11, "PRGn")[c(4,6,8)]
col.set3 <- c(col.set1[3], "#F7F7F7", col.set1[1])
col.set4 <- c(col.set1[1], col.set1[3])
col.set5 <- brewer.pal(n=11, "BrBG")[7:10]
```

# Libraries and colours
```{r}
setwd("/Users/mendenlab/work/spatial_granuloma/scripts/summary")
library(anndata)
library(reticulate)
library(ggplot2)
library(ggpubr)
library(lemon)
library(reshape2)
library(RColorBrewer)
library(grid)
library(gridExtra)

col.set.ylgn <- brewer.pal(n=9, "YlGn")
col.set.spec <- brewer.pal(n=11, "Spectral")

col.set <- list(spots = c("DERMIS" = '#E0EEE0', 
                          "INTERFACE" = 'deepskyblue',
                         "VESSEL" = 'darkgreen',
                         "EPIDERMIS" = 'blue',
                         "HAIR FOLLICLE" = "#543005",
                         "MUSCLE" = 'darkcyan',
                         "SEBACEOUS GLAND" = 'mistyrose',
                         "SWEAT GLAND" = 'yellow',
                         "GNL" = 'orchid',
                         "GSS" = 'blueviolet',
                         "GSC" = 'mediumvioletred',
                         "GA (1)" = '#F46D43', 
                         "GA (2)" = '#D53E4F', 
                         "GA (3)" = '#9E0142',
                         "UNDETERMINED" = 'black'),
                spots_general = c("DERMIS" = '#E0EEE0', 
                          "INTERFACE" = 'deepskyblue',
                         "VESSEL" = 'darkgreen',
                         "EPIDERMIS" = 'blue',
                         "HAIR FOLLICLE" = "#543005",
                         "MUSCLE" = 'darkcyan',
                         "SEBACEOUS GLAND" = 'mistyrose',
                         "SWEAT GLAND" = 'yellow',
                         "GA" = 'firebrick',  
                         "GNL" = 'orchid',
                         "GSS" = 'blueviolet',
                         "GSC" = 'mediumvioletred',
                         "UNDETERMINED" = 'black'),
                dermis = c("UNDETERMINED" = 'black',
                           "upper EPIDERMIS" = 'blue',
                           "middle EPIDERMIS" = 'dodgerblue',
                           "basal EPIDERMIS" = 'skyblue',
                           "DERdepth1" = '#006837',
                           "DERdepth2" = '#238443',
                           "DERdepth3" = '#41AB5D',
                           "DERdepth4" = '#78C679',
                           "DERdepth5" = '#ADDD8E',
                           "DERdepth6" = '#D9F0A3',
                           "DERdepth7" = '#F7FCB9'),
                lesions = c("LESIONAL" = 'tomato',
                            "NON LESIONAL" = 'darkolivegreen',
                            "UNDETERMINED" = 'lightgrey'),
                patients = c("91253" = "#F46D43",#'red',#granuloma annulare
                             "45703" = "#D53E4F",#'indianred',#granuloma annulare
                             "50107" = "#9E0142",#'firebrick',#granuloma annulare
                             "95096" = "orchid", # necrobiosis lipoidica
                             "82301" = "mediumvioletred", #sarcoidosis-cutaneous
                             "72859" = "blueviolet"), #sarcoidosis-suspected
                samples = c("P17851_1001" = '#F46D43',
                            "P17851_1002" = '#FDAE61',
                            "P17851_1003" = '#D53E4F',
                            "P17851_1004" = 'coral3',
                            "P18554_1001" = '#9E0142',
                            "P18554_1002" = 'firebrick3',
                            "P18554_1003" = 'orchid',
                            "P18554_1004" = 'magenta',
                            "P18554_1005" = 'blueviolet',
                            "P18554_1006" = 'mediumpurple',
                            "P18554_1007" = 'mediumvioletred',
                            "P18554_1008" = 'violet'),
                leiden_r0.5 = c("0" = "#E0EEE0",
                                "1" = "#41AB5D",
                                "2" = "#ADDD8E",
                                "3" = "yellow",
                                "4" = "orchid",
                                "5" = "dodgerblue",
                                "6" = "blueviolet",
                                "7" = "#D53E4F",
                                "8" = "#F46D43",
                                "9" = "mistyrose",
                                "10" = "blue",
                                "11" = "#9E0142",
                                "12" = "darkcyan"),
                leiden_r0.8 = c("0"  = 'yellow',
                                "1"  = '#ADDD8E',
                                "2"  = '#E0EEE0',
                                "3"  = '#D9F0A3',
                                "4"  = "#EAADE7",
                                "5"  = 'deepskyblue',
                                "6"  = "orchid",
                                "7"  = "#D53E4F",
                                "8"  = "darkgreen",
                                "9"  = "#F46D43",
                                "10" = "blueviolet",
                                "11" = 'skyblue',
                                "12" = 'blue',
                                "13" = "mediumvioletred",
                                "14" = 'mistyrose',
                                "15" = "#9E0142",
                                "16" = 'darkcyan'),
                leiden_r1.3 = c("0"  = 'darkolivegreen', #mainly contains non-lesional spots
                                "1"  = '#D9F0A3', # dermdepth6
                                "2"  = '#238443', # derdepth2
                                "3"  = 'firebrick', # granuloma
                                "4"  = '#78C679', # derdepth4
                                "5"  = '#78C679', # derdepth4
                                "6"  = "#41AB5D", #dermis depth 3
                                "7"  = "#006837", #derm depth1
                                "8"  = '#ADDD8E', # dermdepth5
                                "9"  = "#238443", #derm depth2
                                "10" = '#78C679', # derdepth4
                                "11" = 'blue', #epidermis
                                "12" = 'orchid', #purple for very low % granuloma --> this is mostly ga
                                "13" = '#F46D43', #orange for very low % granuloma --> this is mostly gnl
                                "14" = 'dodgerblue', #mostly interface, has mid epidermis colour
                                "15" = "deepskyblue", #mostly interface, has interface colour
                                "16" = '#cfafaf', #sebaceous gland. 
                                "17" = 'yellow', # sweat gland
                                "18" = 'darkcyan', # muscle
                                "19" = '#006837')) #derdepth1
```

# Loading data .h5 file to df
```{r}

# Set to T if you want to save the clustering .h5 files created in the jupyter notebook as RDS. 
# This code will convert spot type, skin layers, patients, leiden clusters..., to factors and order them
if(F){
  ad <- read_h5ad("../../results/current/final/Granuloma_QC_clustering.h5")
  saveRDS(ad, file = "../../results/current/final/Granuloma_QC_clustering.RDS")
  names(ad$obsm)
  names(ad$obs)
  
  df <- cbind(ad$obs,
              X_pp_umap1=ad$obsm$X_umap_pp[, 1],
              X_pp_umap2=ad$obsm$X_umap_pp[, 2],
              X_BC_umap1=ad$obsm$X_umap_emb_BIOBANK[, 1],
              X_BC_umap2=ad$obsm$X_umap_emb_BIOBANK[, 2],
              X_BC_disease_umap1=ad$obsm$X_umap_emb_disease[, 1],
              X_BC_disease_umap2=ad$obsm$X_umap_emb_disease[, 2],
              spatial1=ad$obsm$spatial[, 1], spatial2=ad$obsm$spatial[, 2])
  
  if(!is.null(df)){
    saveRDS(df,
            file = "../../results/current/final/Granuloma_QC_clustering_df.RDS")
  }
  
  df$spot_type <- factor(as.character(df$spot_type),
                         levels = c("DERMIS", "INTERFACE",
                                    "EPIDERMIS",
                                    "GA", "GA (1)", "GA (2)", "GA (3)",
                                    "GSS",
                                    "GSC",
                                    "GNL",
                                    "VESSEL", "MUSCLE", "HAIR FOLLICLE", 
                                    "SEBACEOUS GLAND", "SWEAT GLAND", "UNDETERMINED"),
                         ordered = T)
  df$skin_layer <- factor(as.character(df$skin_layer),
                         levels = names(col.set$dermis),
                         ordered = T)
  
  df[df$sample=="P17851_1001",
     c("spatial1", "spatial2")] <- 30000-df[df$sample=="P17851_1001",
                                            c("spatial1", "spatial2")]
  df[df$sample=="P18554_1002",
     c("spatial1", "spatial2")] <- 30000-df[df$sample=="P18554_1002",
                                            c("spatial1", "spatial2")]
  df[df$sample=="P18554_1006",
     c("spatial1", "spatial2")] <- 30000-df[df$sample=="P18554_1006",
                                            c("spatial1", "spatial2")]
  
  df$patient <- factor(df$patient,
                       levels = c("91253", "45703", "50107",
                                  "95096", "82301", "72859"),
                       ordered = T)
  
  df$spot_type <- df$spot_type
  df$spot_type[df$patient=="91253" & df$spot_type=="GA"] <- "GA (1)"
  df$spot_type[df$patient=="45703" & df$spot_type=="GA"] <- "GA (2)"
  df$spot_type[df$patient=="50107" & df$spot_type=="GA"] <- "GA (3)"
  
  df_pp.m <- melt(df,
               measure.vars = c("leiden_r5", "leiden_r3",
                                "leiden_r1.5", "leiden_r1.3",
                                "leiden_r1.0", "leiden_r0.8",
                                "leiden_r0.5", "leiden_r0.3"),
               value.name = "clustering")
  df_pp.m$clustering <- factor(df_pp.m$clustering,
                               levels = as.character(sort(as.numeric(unique(df_pp.m$clustering)))))
  
  df_pp.m <- df_pp.m[order(df_pp.m$spot_type), ]
  
  if(!is.null(df_pp.m)){
    saveRDS(df_pp.m,
            file = "../../results/current/final/Granuloma_QC_clustering_df_pp.m.RDS")
  }
  
  df_BC.m <- melt(df,
               measure.vars = c("leiden_r5_patient", "leiden_r3_patient",
                                "leiden_r1.5_patient", "leiden_r1.3_patient",
                                "leiden_r1.0_patient", "leiden_r0.8_patient",
                                "leiden_r0.5_patient", "leiden_r0.3_patient"),
               value.name = "clustering")
  df_BC.m$clustering <- factor(df_BC.m$clustering,
                               levels = as.character(sort(as.numeric(unique(df_BC.m$clustering)))))
  
  df_BC.m <- df_BC.m[order(df_BC.m$spot_type), ]
  if(!is.null(df_BC.m)){
      saveRDS(df_BC.m,
              file = "../../results/current/final/Granuloma_QC_clustering_df_BC.m.RDS")
  }
  
  # df$leiden_r0.8 <- factor(df$leiden_r0.8,
  #                              levels = as.character(sort(as.numeric(
  #                                unique(as.character(df$leiden_r0.8))))))
  # df$leiden_r0.5 <- factor(df$leiden_r0.5,
  #                              levels = as.character(sort(as.numeric(
  #                                unique(as.character(df$leiden_r0.5))))))
  
  df <- df[order(df$spot_type), ]
  if(!is.null(df)){
    saveRDS(df,
            file = "../../results/current/final/Granuloma_QC_clustering_df.RDS")
  }
  
  
  ## Per sample & granuloma clustering (check jupyter notebook)
  ## It basically does leiden clusters for each patient individually, and then again with only the granuloma spots. 
  ## With this clustering pipeline we obtain a nice cluster with all the granuloma spots so it will be the RDS file we will work with
  
  ad <- read_h5ad("../../results/current/final/Granuloma_QC_clustering_annotations.h5")
  saveRDS(ad, file = "../../results/current/final/Granuloma_QC_clustering_annotations.RDS")
  names(ad$obsm)
  names(ad$obs)
  
  df <- cbind(ad$obs,
              X_pp_umap1=ad$obsm$X_umap_pp[, 1],
              X_pp_umap2=ad$obsm$X_umap_pp[, 2],
              X_BC_umap1=ad$obsm$X_umap_emb_BIOBANK[, 1],
              X_BC_umap2=ad$obsm$X_umap_emb_BIOBANK[, 2],
              X_BC_disease_umap1=ad$obsm$X_umap_emb_disease[, 1],
              X_BC_disease_umap2=ad$obsm$X_umap_emb_disease[, 2],
              spatial1=ad$obsm$spatial[, 1], spatial2=ad$obsm$spatial[, 2])
  
  if(!is.null(df)){
    saveRDS(df,
            file = "../../results/current/final/Granuloma_QC_clustering_annotations_df.RDS")
  }
  
  df$spot_type <- factor(as.character(df$spot_type),
                         levels = c("DERMIS", "INTERFACE",
                                    "EPIDERMIS",
                                    "GA", "GA (1)", "GA (2)", "GA (3)",
                                    "GSS",
                                    "GSC",
                                    "GNL",
                                    "VESSEL", "MUSCLE", "HAIR FOLLICLE", 
                                    "SEBACEOUS GLAND", "SWEAT GLAND", "UNDETERMINED"),
                         ordered = T)
  df$skin_layer <- factor(as.character(df$skin_layer),
                         levels = names(col.set$dermis),
                         ordered = T)
  
  # Correct the orientation of 3 of the tissue samples
  df[df$sample=="P17851_1001",
     c("spatial1", "spatial2")] <- 30000-df[df$sample=="P17851_1001",
                                            c("spatial1", "spatial2")]
  df[df$sample=="P18554_1002",
     c("spatial1", "spatial2")] <- 30000-df[df$sample=="P18554_1002",
                                            c("spatial1", "spatial2")]
  df[df$sample=="P18554_1006",
     c("spatial1", "spatial2")] <- 30000-df[df$sample=="P18554_1006",
                                            c("spatial1", "spatial2")]
  df$patient <- factor(df$patient,
                       levels = c("91253", "45703", "50107",
                                  "95096", "82301", "72859"),
                       ordered = T)
  
  df$spot_type <- df$spot_type
  df$spot_type[df$patient=="91253" & df$spot_type=="GA"] <- "GA (1)"
  df$spot_type[df$patient=="45703" & df$spot_type=="GA"] <- "GA (2)"
  df$spot_type[df$patient=="50107" & df$spot_type=="GA"] <- "GA (3)"
  summary(df$spot_type)
  
  df_pp.m <- melt(df,
               measure.vars = c("leiden_r5", "leiden_r3",
                                "leiden_r1.5", "leiden_r1.3",
                                "leiden_r1.0", "leiden_r0.8",
                                "leiden_r0.5", "leiden_r0.3"),
               value.name = "clustering")
  df_pp.m$clustering <- factor(df_pp.m$clustering,
                               levels = as.character(sort(as.numeric(unique(df_pp.m$clustering)))))
  
  df_pp.m <- df_pp.m[order(df_pp.m$spot_type), ]
  
  if(!is.null(df_pp.m)){
    saveRDS(df_pp.m,
            file = "../../results/current/final/Granuloma_QC_clustering_annotations_df_pp.m.RDS")
  }
  
  df_BC.m <- melt(df,
               measure.vars = c("leiden_r5_patient", "leiden_r3_patient",
                                "leiden_r1.5_patient", "leiden_r1.3_patient",
                                "leiden_r1.0_patient", "leiden_r0.8_patient",
                                "leiden_r0.5_patient", "leiden_r0.3_patient"),
               value.name = "clustering")
  df_BC.m$clustering <- factor(df_BC.m$clustering,
                               levels = as.character(sort(as.numeric(unique(df_BC.m$clustering)))))
  
  df_BC.m <- df_BC.m[order(df_BC.m$spot_type), ]
  if(!is.null(df_BC.m)){
      saveRDS(df_BC.m,
              file = "../../results/current/final/Granuloma_QC_clustering_annotations_df_BC.m.RDS")
  }
  
  # df$leiden_r0.8 <- factor(df$leiden_r0.8,
  #                              levels = as.character(sort(as.numeric(
  #                                unique(as.character(df$leiden_r0.8))))))
  # df$leiden_r0.5 <- factor(df$leiden_r0.5,
  #                              levels = as.character(sort(as.numeric(
  #                                unique(as.character(df$leiden_r0.5))))))
  
  df <- df[order(df$spot_type), ]
  if(!is.null(df)){
    saveRDS(df,
            file = "../../results/current/final/Granuloma_QC_clustering_annotations_df.RDS")
  }
} else {
  # df <- readRDS("../../results/current/final/Granuloma_QC_clustering_df.RDS")
  # df_pp.m <- readRDS("../../results/current/final/Granuloma_QC_clustering_df_pp.m.RDS")
  # df_BC.m <- readRDS("../../results/current/final/Granuloma_QC_clustering_df_BC.m.RDS")
  df <- readRDS("../../results/current/final/Granuloma_QC_clustering_annotations_df.RDS")
  df_pp.m <- readRDS("../../results/current/final/Granuloma_QC_clustering_annotations_df_pp.m.RDS")
  df_BC.m <- readRDS("../../results/current/final/Granuloma_QC_clustering_annotations_df_BC.m.RDS")
}
  
```

# Sample batch correction 
```{r}
# The sample batch correction did not show great differences so we will skip it and only correct per patient + granuloma

# if(F){
#   ## sample batch corrected ----
#     ad.sample <- read_h5ad("../../results/current/2021-07-29/final/Granuloma_BC_sample.h5")
#     
#     df.sample <- cbind(ad.sample$obs,
#                 X_umap1=ad.sample$obsm$X_umap[, 1], X_umap2=ad.sample$obsm$X_umap[, 2],
#                 spatial1=ad.sample$obsm$spatial[, 1], spatial2=ad.sample$obsm$spatial[, 2])
#     
#     df.sample$spot_type <- factor(as.character(df.sample$spot_type),
#                            levels = c("Dermis", "Interface",
#                                       "KERATINOCYTE",
#                                       "Granuloma an.", "Granuloma an. (1)",
#                                       "Granuloma an. (2)", "Granuloma an. (3)",
#                                       "Granuloma sarc. sys.",
#                                       "Granuloma sarc. susp.",
#                                       "Granuloma sarc. cut.",
#                                       "ENDOTHELIAL", "MUSCLE",
#                                       "SEBACEOUS GLAND", "SWEAT GLAND"),
#                            ordered = T)
#     df.sample$skin_layer <- factor(as.character(df.sample$skin_layer),
#                            levels = names(col.set$dermis),
#                            ordered = T)
#     
#     
#     df.sample[df.sample$sample=="P17851_1001",
#        c("spatial1", "spatial2")] <- 30000-df.sample[df.sample$sample=="P17851_1001",
#                                               c("spatial1", "spatial2")]
#     df.sample[df.sample$sample=="P18554_1002",
#        c("spatial1", "spatial2")] <- 30000-df.sample[df.sample$sample=="P18554_1002",
#                                               c("spatial1", "spatial2")]
#     df.sample[df.sample$sample=="P18554_1006",
#        c("spatial1", "spatial2")] <- 30000-df.sample[df.sample$sample=="P18554_1006",
#                                               c("spatial1", "spatial2")]
#     
#     df.sample$patient <- factor(df.sample$patient,
#                          levels = c("91253", "45703", "50107",
#                                     "95096", "82301", "72859"),
#                          ordered = T)
#     
#     df.sample$spot_type <- df.sample$spot_type
#     df.sample$spot_type[df.sample$patient=="91253" & df.sample$spot_type=="Granuloma an."] <- "Granuloma an. (1)"
#     df.sample$spot_type[df.sample$patient=="45703" & df.sample$spot_type=="Granuloma an."] <- "Granuloma an. (2)"
#     df.sample$spot_type[df.sample$patient=="50107" & df.sample$spot_type=="Granuloma an."] <- "Granuloma an. (3)"
#     
#     df.sample$leiden_r0.8 <- factor(df.sample$leiden_r0.8,
#                                  levels = as.character(sort(as.numeric(
#                                    unique(as.character(df.sample$leiden_r0.8))))))
#     df.sample$leiden_r0.5 <- factor(df.sample$leiden_r0.5,
#                                  levels = as.character(sort(as.numeric(
#                                    unique(as.character(df.sample$leiden_r0.5))))))
#     
#     df.sample <- df.sample[order(df.sample$spot_type), ]
#     
#   ## patient batch corrected ----
#     ad.patient <- read_h5ad("../../results/current/2021-07-29/final/Granuloma_BC_patient.h5")
#     
#     df.patient <- cbind(ad.patient$obs,
#                 X_umap1=ad.patient$obsm$X_umap[, 1], X_umap2=ad.patient$obsm$X_umap[, 2],
#                 spatial1=ad.patient$obsm$spatial[, 1], spatial2=ad.patient$obsm$spatial[, 2])
#     
#     df.patient$spot_type <- factor(as.character(df.patient$spot_type),
#                            levels = c("Dermis", "Interface",
#                                       "KERATINOCYTE",
#                                       "Granuloma an.", "Granuloma an. (1)",
#                                       "Granuloma an. (2)", "Granuloma an. (3)",
#                                       "Granuloma sarc. sys.",
#                                       "Granuloma sarc. susp.",
#                                       "Granuloma sarc. cut.",
#                                       "ENDOTHELIAL", "MUSCLE",
#                                       "SEBACEOUS GLAND", "SWEAT GLAND"),
#                            ordered = T)
#     df.patient$skin_layer <- factor(as.character(df.patient$skin_layer),
#                            levels = names(col.set$dermis),
#                            ordered = T)
#     
#     
#     df.patient[df.patient$sample=="P17851_1001",
#        c("spatial1", "spatial2")] <- 30000-df.patient[df.patient$sample=="P17851_1001",
#                                               c("spatial1", "spatial2")]
#     df.patient[df.patient$sample=="P18554_1002",
#        c("spatial1", "spatial2")] <- 30000-df.patient[df.patient$sample=="P18554_1002",
#                                               c("spatial1", "spatial2")]
#     df.patient[df.patient$sample=="P18554_1006",
#        c("spatial1", "spatial2")] <- 30000-df.patient[df.patient$sample=="P18554_1006",
#                                               c("spatial1", "spatial2")]
#     
#     df.patient$patient <- factor(df.patient$patient,
#                          levels = c("91253", "45703", "50107",
#                                     "95096", "82301", "72859"),
#                          ordered = T)
#     
#     df.patient$spot_type <- df.patient$spot_type
#     df.patient$spot_type[df.patient$patient=="91253" & df.patient$spot_type=="Granuloma an."] <- "Granuloma an. (1)"
#     df.patient$spot_type[df.patient$patient=="45703" & df.patient$spot_type=="Granuloma an."] <- "Granuloma an. (2)"
#     df.patient$spot_type[df.patient$patient=="50107" & df.patient$spot_type=="Granuloma an."] <- "Granuloma an. (3)"
#     
#     df.patient$leiden_r0.8 <- factor(df.patient$leiden_r0.8,
#                                  levels = as.character(sort(as.numeric(
#                                    unique(as.character(df.patient$leiden_r0.8))))))
#     df.patient$leiden_r0.5 <- factor(df.patient$leiden_r0.5,
#                                  levels = as.character(sort(as.numeric(
#                                    unique(as.character(df.patient$leiden_r0.5))))))
#     
#     df.patient <- df.patient[order(df.patient$spot_type), ]
#     
#   ## disease batch corrected ----
#     ad.disease <- read_h5ad("../../results/current/2021-09-08/final/Granuloma_BC_disease.h5")
#     
#     df.disease <- cbind(ad.disease$obs,
#                 X_umap1=ad.disease$obsm$X_umap[, 1], X_umap2=ad.disease$obsm$X_umap[, 2],
#                 spatial1=ad.disease$obsm$spatial[, 1], spatial2=ad.disease$obsm$spatial[, 2])
#     
#     df.disease$spot_type <- factor(as.character(df.disease$spot_type),
#                            levels = c("Dermis", "Interface",
#                                       "KERATINOCYTE",
#                                       "Granuloma an.", "Granuloma an. (1)",
#                                       "Granuloma an. (2)", "Granuloma an. (3)",
#                                       "Granuloma sarc. sys.",
#                                       "Granuloma sarc. susp.",
#                                       "Granuloma sarc. cut.",
#                                       "ENDOTHELIAL", "MUSCLE",
#                                       "SEBACEOUS GLAND", "SWEAT GLAND"),
#                            ordered = T)
#     df.disease$skin_layer <- factor(as.character(df.disease$skin_layer),
#                            levels = names(col.set$dermis),
#                            ordered = T)
#     
#     
#     df.disease[df.disease$sample=="P17851_1001",
#        c("spatial1", "spatial2")] <- 30000-df.disease[df.disease$sample=="P17851_1001",
#                                               c("spatial1", "spatial2")]
#     df.disease[df.disease$sample=="P18554_1002",
#        c("spatial1", "spatial2")] <- 30000-df.disease[df.disease$sample=="P18554_1002",
#                                               c("spatial1", "spatial2")]
#     df.disease[df.disease$sample=="P18554_1006",
#        c("spatial1", "spatial2")] <- 30000-df.disease[df.disease$sample=="P18554_1006",
#                                               c("spatial1", "spatial2")]
#     
#     df.disease$patient <- factor(df.disease$patient,
#                          levels = c("91253", "45703", "50107",
#                                     "95096", "82301", "72859"),
#                          ordered = T)
#     
#     df.disease$spot_type <- df.disease$spot_type
#     df.disease$spot_type[df.disease$patient=="91253" & df.disease$spot_type=="Granuloma an."] <- "Granuloma an. (1)"
#     df.disease$spot_type[df.disease$patient=="45703" & df.disease$spot_type=="Granuloma an."] <- "Granuloma an. (2)"
#     df.disease$spot_type[df.disease$patient=="50107" & df.disease$spot_type=="Granuloma an."] <- "Granuloma an. (3)"
#     
#     df.disease$leiden_r0.8 <- factor(df.disease$leiden_r0.8,
#                                  levels = as.character(sort(as.numeric(
#                                    unique(as.character(df.disease$leiden_r0.8))))))
#     df.disease$leiden_r0.5 <- factor(df.disease$leiden_r0.5,
#                                  levels = as.character(sort(as.numeric(
#                                    unique(as.character(df.disease$leiden_r0.5))))))
#     
#     df.disease <- df.disease[order(df.disease$spot_type), ]
# }


```

# UMAPs: No correction + patient batch correction
```{r}

# UMAPs using non-corrected data (only preprocessed) coloured by spot_type
UMAP_pp_spottype <- ggplot(df, aes(x = X_pp_umap1, y = X_pp_umap2, col = spot_type)) +
    geom_point(size = 0.5) +
    #scale_x_reverse() +
    #scale_y_reverse() +
    scale_color_manual("", values = col.set$spots) +
    labs(title = "No batch correction",
         x = "UMAP 1",
         y = "UMAP 2") +
    theme_bw() +
    theme(aspect.ratio = 1, plot.title = element_text(hjust = 0.5)) +
    guides(colour = guide_legend(override.aes = list(size = 4)))

# UMAPs using patient batch-corrected data coloured by spot_type
UMAP_BC_spottype <- ggplot(df,
         aes(x = X_BC_umap1, y = X_BC_umap2, col = spot_type)) +
    geom_point(size = 0.5) +
    scale_color_manual("", values = col.set$spots) +
    labs(title = "Patient batch correction",
         x = "UMAP 1",
         y = "UMAP 2") +
    theme_bw() +
    theme(aspect.ratio = 1, plot.title = element_text(hjust = 0.5)) +
    guides(colour = guide_legend(override.aes = list(size = 4)))

# UMAPs using patient batch-corrected data coloured by skin_layer
UMAP_BC_skinlayer <- ggplot(df,
         aes(x = X_BC_umap1, y = X_BC_umap2, col = skin_layer)) +
    geom_point(size = 0.5) +
    scale_color_manual("", values = col.set$dermis) +
    labs(title = "Patient batch correction",
         x = "UMAP 1",
         y = "UMAP 2") +
    theme_bw() +
    theme(aspect.ratio = 1, plot.title = element_text(hjust = 0.5)) +
    guides(colour = guide_legend(override.aes = list(size = 4)))

# UMAPs using patient batch-corrected data coloured by sample
UMAP_BC_sample <- ggplot(df,
         aes(x = X_BC_umap1, y = X_BC_umap2, col = sample)) +
    geom_point(size = 0.5) +
    scale_color_manual("", values = col.set$samples) +
    labs(title = "Patient batch correction",
         x = "UMAP 1",
         y = "UMAP 2") +
    theme_bw() +
    theme(aspect.ratio = 1, plot.title = element_text(hjust = 0.5)) +
    guides(colour = guide_legend(override.aes = list(size = 4)))

# UMAP using patient batch-corrected data coloured by leiden clusters with r=1.3
UMAP_BC_leiden1.3 <- ggplot(df,
         aes(x = X_BC_umap1, y = X_BC_umap2, col = leiden_r1.3_patient)) +
    geom_point(size = 0.5) +
    scale_color_manual("", values = col.set$leiden_r1.3) +
    labs(title = "Leiden clustering r = 1.3 (patient batch correction)",
         x = "UMAP 1",
         y = "UMAP 2") +
    theme_bw() +
    theme(aspect.ratio = 1, plot.title = element_text(hjust = 0.5)) +
    guides(colour = guide_legend(override.aes = list(size = 4)))

# UMAPs using disease batch-corrected data coloured by sample
UMAP_disease_spottype <- ggplot(df,
         aes(x=X_BC_disease_umap1, y=X_BC_disease_umap2, col=spot_type)) +
    geom_point(size=0.5) +
    scale_color_manual("", values = col.set$spots) +
    labs(title = "Disease batch correction",
         x = "UMAP 1",
         y = "UMAP 2") +
    theme_bw() +
    theme(aspect.ratio = 1,
          plot.title = element_text(hjust = 0.5)) +
    guides(colour = guide_legend(override.aes = list(size = 4)))

# If you want to add a legend or remove it:
legend_spottype <- as_ggplot(get_legend(UMAP_BC_spottype +
                       geom_point(size = 5) +
                       theme(legend.position  =  "right"))) # change to 'bottom' or 'none'

```

## Visualisation
### All in line 
```{r, fig.width=20, fig.height=6}
ggarrange(
  UMAP_pp_spottype + theme(legend.position = "none"),
  UMAP_BC_spottype + theme(legend.position = "none"),
  #UMAP_BC_skinlayer + theme(legend.position = "none"),
  UMAP_disease_spottype + theme(legend.position = "none"),
  as_ggplot(get_legend(UMAP_BC_spottype +
                         geom_point(size = 5))),
  nrow = 1, ncol = 4,
  common.legend = T, legend = "none",
  widths = c(1, 1, 1, 0.5)
)

#ggsave(filename = 'UMAPs_batchvsnobatch', path = "/Volumes/Drive/spatial_granuloma/output/plots/Preprocessing/", width = 20, height = 5, device='tiff', dpi=700)
```
### All in 2 x 2
```{r, fig.width=16, fig.height=20}

ggarrange(
  UMAP_pp_spottype + theme(legend.position = "none"),
  UMAP_BC_spottype + theme(legend.position = "none"),
  UMAP_disease_spottype + theme(legend.position = "none"),
  as_ggplot(get_legend(UMAP_BC_spottype +
                         geom_point(size = 5))),
  nrow = 2, ncol = 2,
  common.legend = T, legend = "none",
  widths = c(1, 1, 1, 1)
)
```
# UMAPS for SAMPLE == 0
```{r, fig.width=20, fig.height=10}
ggarrange(
  ggarrange(
    ggplot(df[sample(which(df$`NON LESIONAL`==1 & df$DERMIS==1 & df$SAMPLE!="0"),
                     sum(df$`NON LESIONAL`==1 & df$DERMIS==1 & df$SAMPLE!="0")), ],
           aes(x=X_pp_umap1, y=X_pp_umap2, col=sample)) +
      geom_point(size=0.5) +
      scale_color_manual("", values = col.set$samples) +
      labs(title = "Non-lesional dermis spots\n No batch correction",
           x = "UMAP 1",
           y = "UMAP 2") +
      theme_bw() +
      theme(aspect.ratio = 1,
            plot.title = element_text(hjust = 0.5)),
    ggplot(df[sample(which(df$`NON LESIONAL`==1 & df$DERMIS==1 & df$SAMPLE!="0"),
                     sum(df$`NON LESIONAL`==1 & df$DERMIS==1 & df$SAMPLE!="0")), ],
           aes(x=X_BC_umap1, y=X_BC_umap2, col=sample)) +
      geom_point(size=0.5) +
      scale_color_manual("", values = col.set$samples) +
      labs(title = "Non-lesional dermis spots\n Patient batch correction",
           x = "UMAP 1",
           y = "UMAP 2") +
      theme_bw() +
      theme(aspect.ratio = 1,
            plot.title = element_text(hjust = 0.5)),
    ggplot(df[sample(which(df$`NON LESIONAL`==1 & df$DERMIS==1 & df$SAMPLE!="0"),
                     sum(df$`NON LESIONAL`==1 & df$DERMIS==1 & df$SAMPLE!="0")), ],
           aes(x=X_BC_disease_umap1, y=X_BC_disease_umap2, col=sample)) +
      geom_point(size=0.5) +
      scale_color_manual("", values = col.set$samples) +
      labs(title = "Non-lesional dermis spots\n Disease batch correction",
           x = "UMAP 1",
           y = "UMAP 2") +
      theme_bw() +
      theme(aspect.ratio = 1,
            plot.title = element_text(hjust = 0.5)),
    nrow = 1, ncol = 3,
    common.legend = T, legend = "none"),
  as_ggplot(get_legend(umap_patient +
                         geom_point(size=5) +
                         theme(legend.position = "bottom"))),
  nrow = 2, ncol = 1, heights = c(3,1)
)
```

# UMAPs: coloured by Spot type, skin layer, leiden 1.3 
```{r, fig.width=20, fig.height=6}
# Plot all
ggarrange(UMAP_BC_spottype + theme(legend.position = "none") + labs(title = "\n \n Spot type"),
          UMAP_BC_skinlayer + theme(legend.position = "none") + labs(title = "Patient batch correction\n \n Dermis layers"),
          UMAP_BC_leiden1.3 + theme(legend.position = "none") + labs(title = "\n \n Leiden r = 1.3"),
    as_ggplot(get_legend(UMAP_BC_spottype +
                         geom_point(size = 5))),
    as_ggplot(get_legend(UMAP_BC_skinlayer +
                         geom_point(size = 5))),
    as_ggplot(get_legend(UMAP_BC_leiden1.3 +
                         geom_point(size = 5))),
  nrow = 1, ncol = 6,
  common.legend = T, legend = "none",
  widths = c(1, 1, 1, 0.5, 0.5, 0.5)
)

```

# Leiden clustering
## All
```{r, fig.width=30, fig.height=25}

# Show spot type annotations distribution across clusters for leiden clustering (with different r) 
# No batch correction
leiden_pp_spottype  <- ggplot(data=df_pp.m[order(df_pp.m$spot_type), ],
       aes(x=clustering, fill=spot_type)) +
  geom_bar(stat="count", position = "stack") + #stack #fill
  scale_fill_manual("", values = col.set$spots) +
  theme_bw() +
  ggtitle("Leiden clustering (no batch correction)") +
  facet_wrap(.~variable,
             scales = "free", #space = "free_x",
             nrow = 3)

# Show skin layer annotations distribution across clusters for leiden clustering (with different r) 
# No batch correction
leiden_pp_skinlayer  <- ggplot(data=df_pp.m[order(df_pp.m$skin_layer), ],
       aes(x=clustering, fill=skin_layer)) +
  geom_bar(stat="count", position = "stack") + #stack #fill
  scale_fill_manual("", values = col.set$dermis) +
  ggtitle("Leiden clustering (no batch correction)") +
  theme_bw() +
  facet_wrap(.~variable,
             scales = "free",
             nrow = 3)

# Show spot type annotations distribution across clusters for leiden clustering (with different r) 
# With batch correction
leiden_BC_spottype  <- ggplot(data=df_BC.m[order(df_BC.m$spot_type), ],
       aes(x=clustering, fill=spot_type)) +
  geom_bar(stat="count", position = "stack") + #stack #fill
  scale_fill_manual("", values = col.set$spots) +
  ggtitle("Leiden clustering (patient batch correction)") +
  theme_bw() +
  facet_wrap(.~variable,
             scales = "free", #space = "free_x",
             nrow = 3) +
  theme(legend.position = "bottom")

# Show skin layer annotations distribution across clusters for leiden clustering (with different r) 
# With batch correction
leiden_BC_skinlayer  <- ggplot(data=df_BC.m[df_BC.m$GRANULOMA==0, ],
       aes(x=clustering, fill=skin_layer)) +
  geom_bar(stat="count", position = "stack") + #stack #fill
  scale_fill_manual("", values = col.set$dermis) +
  ggtitle("Leiden clustering (patient batch correction, without granuloma spots)") +
  theme_bw() +
  facet_wrap(.~variable,
             scales = "free",
             nrow = 3)
```

## Leiden choose r
```{r, fig.width=30, fig.height=25}
# Choose r to compute plots
leiden_r <- 0.5 

ggarrange(
  ggarrange(
    ggplot(data=df,
           aes(x= .data[[paste0('leiden_r', leiden_r)]], fill=spot_type)) + # this is like saying x = df$leiden_r0.5
      geom_bar(stat="count", position = "fill") +
      scale_fill_manual("", values = col.set$spots) +
      theme_bw(),
    NULL,
    nrow = 1, ncol = 2,
    widths = c(1, 0.026)),
  ggarrange(
    ggplot(data=df[df$GRANULOMA=="0", ],
           aes(x=.data[[paste0('leiden_r', leiden_r)]], fill=patient)) +
      geom_bar(stat="count", position = "stack") +
      scale_fill_manual("", values = col.set$patients) +
      labs(title = "Non-lesional spots only") +
      theme_bw(),
    NULL,
    nrow = 1, ncol = 2,
    widths = c(1, 0.079)),
  ggarrange(
    ggplot(data=df,
           aes(x=.data[[paste0('leiden_r', leiden_r)]], fill=biopsy_type)) +
      geom_bar(stat="count", position = "stack") +
      scale_fill_manual("", values = col.set$lesions) +
      theme_bw(),
    NULL,
    nrow = 1, ncol = 2,
    widths = c(1, 0.035)),
  ggarrange(
    ggplot(data=df,
           aes(x=.data[[paste0('leiden_r', leiden_r)]], fill=skin_layer)) +
      geom_bar(stat="count", position = "stack") +
      scale_fill_manual("", values = col.set$dermis) +
      theme_bw(),
    NULL,
    nrow = 1, ncol = 2,
    widths = c(1, 0.03)),
  nrow = 2, ncol = 2,
  common.legend = F)
```
## Leiden 0.8
```{r, fig.width=30, fig.height=20}
leiden0.8_bar_spot <- 
  ggplot(data=df,
         aes(x=leiden_r0.8, fill=spot_type)) +
    geom_bar(stat="count", position = "fill") +
    scale_fill_manual("", values = col.set$spots) +
    labs(title = "Clusters by spot annotations") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

leiden0.8_bar_skin <-
  ggplot(data=df,
         aes(x=leiden_r0.8, fill=skin_layer)) +
    geom_bar(stat="count", position = "fill") +
    scale_fill_manual("", values = col.set$dermis) +
    labs(title = "Clusters by skin layers") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

leiden0.8_bar_biopsy <-
  ggplot(data=df,
       aes(x=leiden_r0.8, fill=biopsy_type)) +
    geom_bar(stat="count", position = "fill") +
    scale_fill_manual("", values = col.set$lesions) +
    labs(title = "Lesional or non-lesional spots") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

leiden0.8_bar_patient <-
  ggplot(data=df[df$GRANULOMA=="0", ],
         aes(x=leiden_r0.8, fill=patient)) +
    geom_bar(stat="count", position = "fill") +
    scale_fill_manual("", values = col.set$patients) +
    labs(title = "Donors for non-lesional spots") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

leiden0.8_bar_patient_lesional <-  
  ggplot(data=df[df$GRANULOMA=="1", ],
         aes(x=leiden_r0.8, fill=patient)) +
    geom_bar(stat="count", position = "fill") +
    scale_fill_manual("", values = col.set$patients) +
    labs(title = "Donors for lesional spots") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

## BC ----
leiden0.8_BC_bar_spot <- 
  ggplot(data=df,
         aes(x=leiden_r0.8_patient, fill=spot_type)) +
    geom_bar(stat="count", position = "fill") +
    scale_fill_manual("", values = col.set$spots) +
    labs(title = "Clusters by spot annotations") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

leiden0.8_BC_bar_skin <-
  ggplot(data=df,
         aes(x=leiden_r0.8_patient, fill=skin_layer)) +
    geom_bar(stat="count", position = "fill") +
    scale_fill_manual("", values = col.set$dermis) +
    labs(title = "Clusters by skin layers") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

leiden0.8_BC_bar_biopsy <-
  ggplot(data=df,
       aes(x=leiden_r0.8_patient, fill=biopsy_type)) +
    geom_bar(stat="count", position = "fill") +
    scale_fill_manual("", values = col.set$lesions) +
    labs(title = "Lesional or non-lesional spots") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

leiden0.8_BC_bar_patient <-
  ggplot(data=df[df$GRANULOMA=="0", ],
         aes(x=leiden_r0.8_patient, fill=patient)) +
    geom_bar(stat="count", position = "fill") +
    scale_fill_manual("", values = col.set$patients) +
    labs(title = "Donors for non-lesional spots") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

# Show no BC vs BC all plots
ggarrange(
  #ggarrange(
    as_ggplot(get_legend(leiden0.8_bar_spot)),
    #as_ggplot(get_legend(leiden0.8_bar_skin)),
    #nrow = 2, ncol = 1,
    #align = "hv"),
  leiden0.8_bar_spot + theme(legend.position = "none"),
  leiden0.8_bar_skin + theme(legend.position = "none"),
  leiden0.8_bar_biopsy + theme(legend.position = c(0.68,0.915)),
  leiden0.8_bar_patient + theme(legend.position = c(0.82,0.857)),
    #ggarrange(
    #as_ggplot(get_legend(leiden0.8_BC_bar_spot)),
    as_ggplot(get_legend(leiden0.8_BC_bar_skin)),
    #nrow = 2, ncol = 1,
    #align = "hv"),
  leiden0.8_BC_bar_spot + theme(legend.position = "none"),
  leiden0.8_BC_bar_skin + theme(legend.position = "none"),
  leiden0.8_BC_bar_biopsy + theme(legend.position = c(0.68,0.915)),
  leiden0.8_BC_bar_patient + theme(legend.position = c(0.82,0.857)),
  nrow = 2, ncol = 5, widths = c(1,1.5,1.5,1.5,1.5)
)

# if(F){ ### INES
# ggarrange(
#   ggplot(data=df,
#          aes(x=X_umap1, y=X_umap2,
#              col=leiden_r0.5)) +
#     geom_point() +
#     scale_color_manual("", values = col.set$leiden_r0.5) +
#     theme_bw() +
#     theme(aspect.ratio = 1) +
#     ggtitle("Leiden clustering (r = 0.5)"),
#   ggplot(data=df,
#          aes(x=X_umap1, y=X_umap2,
#              col=spot_type)) +
#     geom_point() +
#     scale_color_manual("", values = col.set$spots) +
#     theme_bw() +
#     theme(aspect.ratio = 1,
#           legend.position = "bottom") +
#     facet_wrap(.~leiden_r0.5,
#                scales = "fixed", #space = "free_x",
#                nrow = 3),
#   nrow = 1, ncol = 2,
#   widths = c(1,2)
# )
#}
```
##Fractions and cluster size r0.8
```{r}
ggarrange(
    ggarrange(
      ggplot(data=df,
             aes(x=leiden_r0.8, fill=spot_type)) +
        geom_bar(stat="count", position = "fill") + #stack #fill
        scale_fill_manual("", values = col.set$spots) +
        labs(title = "Fractions",
             x = "Clusters (Leiden clustering r=0.8)") +
        theme_bw() +
        theme(legend.position = "none",
              axis.title.x = element_blank()) +
        coord_flip(),
      ggplot(data=df, aes(x=leiden_r0.8, fill= leiden_r0.8)) +
        geom_bar(stat="count", position = "stack") + #stack #fill
        scale_fill_manual("", values = col.set$leiden_r0.8) +
        labs(title = "Cluster size (spots)") +
        theme_bw() +
        theme(#axis.line.x = element_line(colour = "white"),
              #axis.text.x = element_text(colour = "white"),
              #axis.ticks.x = element_line(colour = "white"),
              #axis.title.x = element_text(colour = "white"),
              axis.line.y = element_blank(),
              axis.text.y = element_blank(),
              axis.ticks.y = element_blank(),
              axis.title = element_blank(),
              legend.position = "none") +
        coord_flip(),
    nrow = 1, ncol = 2,
    widths = c(5, 3),
    common.legend = T, legend = "none")#,
)
  # ggarrange(
  #   ggplot(data=df,
  #          aes(x=spatial1, y=spatial2, col=spot_type)) +
  #     geom_point(size=0.1) +
  #     scale_color_manual("", values = col.set$spots) +
  #     labs(title = "Spatial representation of manual annotations") +
  #     theme_bw() +
  #     theme(aspect.ratio = 1,
  #           axis.title = element_blank(),
  #           axis.text.y = element_blank(),
  #           axis.ticks.y = element_blank(),
  #           axis.text.x = element_text(colour = "white"),
  #           axis.ticks.x = element_line(colour = "white"),
  #           legend.position = "none") +
  #     facet_wrap(.~sample,
  #                scales = "fixed", #space = "free_x",
  #                nrow = 2),
  #   ggplot(data=df,
  #          aes(x=spatial1, y=spatial2, col=leiden_r0.8_patient)) +
  #     geom_point(size=0.1) +
  #     scale_color_manual("", values = col.set$leiden_r0.8_patient) +
  #     labs(title = "Spatial representation of Leiden clusters") +
  #     theme_bw() +
  #     theme(aspect.ratio = 1,
  #           axis.title = element_blank(),
  #           axis.text.y = element_blank(),
  #           axis.ticks.y = element_blank(),
  #           axis.text.x = element_text(colour = "white"),
  #           axis.ticks.x = element_line(colour = "white"),
  #           legend.position = "none") +
  #     facet_wrap(.~sample,
  #                scales = "fixed",
  #                nrow = 2),
  #   nrow = 2, ncol = 1),
  # as_ggplot(get_legend(leiden0.8_bar_spot)),
  # nrow = 1, ncol = 3,
  # widths = c(2,3,0.7))
```
##Leiden 0.5
```{r, fig.width=30, fig.height=20}
leiden0.5_bar_spot <- 
  ggplot(data=df,
         aes(x=leiden_r0.5, fill=spot_type)) +
    geom_bar(stat="count", position = "fill") +
    scale_fill_manual("", values = col.set$spots) +
    labs(title = "Clusters by spot annotations") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

leiden0.5_bar_skin <-
  ggplot(data=df,
         aes(x=leiden_r0.5, fill=skin_layer)) +
    geom_bar(stat="count", position = "fill") +
    scale_fill_manual("", values = col.set$dermis) +
    labs(title = "Clusters by skin layers") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

leiden0.5_bar_biopsy <-
  ggplot(data=df,
       aes(x=leiden_r0.5, fill=biopsy_type)) +
    geom_bar(stat="count", position = "fill") +
    scale_fill_manual("", values = col.set$lesions) +
    labs(title = "Lesional or non-lesional spots") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

leiden0.5_bar_patient <-
  ggplot(data=df[df$GRANULOMA=="0", ],
         aes(x=leiden_r0.5, fill=patient)) +
    geom_bar(stat="count", position = "fill") +
    scale_fill_manual("", values = col.set$patients) +
    labs(title = "Donors for non-lesional spots") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

leiden0.5_bar_patient_lesional <-  
  ggplot(data=df[df$GRANULOMA=="1", ],
         aes(x=leiden_r0.5, fill=patient)) +
    geom_bar(stat="count", position = "fill") +
    scale_fill_manual("", values = col.set$patients) +
    labs(title = "Donors for lesional spots") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

## BC ----
leiden0.5_BC_bar_spot <- 
  ggplot(data=df,
         aes(x=leiden_r0.5_patient, fill=spot_type)) +
    geom_bar(stat="count", position = "fill") +
    scale_fill_manual("", values = col.set$spots) +
    labs(title = "Clusters by spot annotations") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

leiden0.5_BC_bar_skin <-
  ggplot(data=df,
         aes(x=leiden_r0.5_patient, fill=skin_layer)) +
    geom_bar(stat="count", position = "fill") +
    scale_fill_manual("", values = col.set$dermis) +
    labs(title = "Clusters by skin layers") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

leiden0.5_BC_bar_biopsy <-
  ggplot(data=df,
       aes(x=leiden_r0.5_patient, fill=biopsy_type)) +
    geom_bar(stat="count", position = "fill") +
    scale_fill_manual("", values = col.set$lesions) +
    labs(title = "Lesional or non-lesional spots") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

leiden0.5_BC_bar_patient <-
  ggplot(data=df[df$GRANULOMA=="0", ],
         aes(x=leiden_r0.5_patient, fill=patient)) +
    geom_bar(stat="count", position = "fill") +
    scale_fill_manual("", values = col.set$patients) +
    labs(title = "Donors for non-lesional spots") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

# Show no BC vs BC all plots
ggarrange(
  #ggarrange(
    as_ggplot(get_legend(leiden0.5_bar_spot)),
    #as_ggplot(get_legend(leiden0.5_bar_skin)),
    #nrow = 2, ncol = 1,
    #align = "hv"),
  leiden0.5_bar_spot + theme(legend.position = "none"),
  leiden0.5_bar_skin + theme(legend.position = "none"),
  leiden0.5_bar_biopsy + theme(legend.position = c(0.68,0.915)),
  leiden0.5_bar_patient + theme(legend.position = c(0.52,0.557)),
    #ggarrange(
    #as_ggplot(get_legend(leiden0.5_BC_bar_spot)),
    as_ggplot(get_legend(leiden0.5_BC_bar_skin)),
    #nrow = 2, ncol = 1,
    #align = "hv"),
  leiden0.5_BC_bar_spot + theme(legend.position = "none"),
  leiden0.5_BC_bar_skin + theme(legend.position = "none"),
  leiden0.5_BC_bar_biopsy + theme(legend.position = c(0.68,0.915)),
  leiden0.5_BC_bar_patient + theme(legend.position = c(0.52,0.557)),
  nrow = 2, ncol = 5, widths = c(1,1.5,1.5,1.5,1.5)
)

# if(F){ ### INES
# ggarrange(
#   ggplot(data=df,
#          aes(x=X_umap1, y=X_umap2,
#              col=leiden_r0.5)) +
#     geom_point() +
#     scale_color_manual("", values = col.set$leiden_r0.5) +
#     theme_bw() +
#     theme(aspect.ratio = 1) +
#     ggtitle("Leiden clustering (r = 0.5)"),
#   ggplot(data=df,
#          aes(x=X_umap1, y=X_umap2,
#              col=spot_type)) +
#     geom_point() +
#     scale_color_manual("", values = col.set$spots) +
#     theme_bw() +
#     theme(aspect.ratio = 1,
#           legend.position = "bottom") +
#     facet_wrap(.~leiden_r0.5,
#                scales = "fixed", #space = "free_x",
#                nrow = 3),
#   nrow = 1, ncol = 2,
#   widths = c(1,2)
# )
#}
```

##Fractions and cluster size r0.5
```{r}
ggarrange(
    ggarrange(
      ggplot(data=df,
             aes(x=leiden_r0.5, fill=spot_type)) +
        geom_bar(stat="count", position = "fill") + #stack #fill
        scale_fill_manual("", values = col.set$spots) +
        labs(title = "Fractions",
             x = "Clusters (Leiden clustering r=0.5)") +
        theme_bw() +
        theme(legend.position = "none",
              axis.title.x = element_blank()) +
        coord_flip(),
      ggplot(data=df, aes(x=leiden_r0.5, fill= leiden_r0.5)) +
        geom_bar(stat="count", position = "stack") + #stack #fill
        scale_fill_manual("", values = col.set$leiden_r0.5) +
        labs(title = "Cluster size (spots)") +
        theme_bw() +
        theme(#axis.line.x = element_line(colour = "white"),
              #axis.text.x = element_text(colour = "white"),
              #axis.ticks.x = element_line(colour = "white"),
              #axis.title.x = element_text(colour = "white"),
              axis.line.y = element_blank(),
              axis.text.y = element_blank(),
              axis.ticks.y = element_blank(),
              axis.title = element_blank(),
              legend.position = "none") +
        coord_flip(),
    nrow = 1, ncol = 2,
    widths = c(5, 3),
    common.legend = T, legend = "none")#,
)
  # ggarrange(
  #   ggplot(data=df,
  #          aes(x=spatial1, y=spatial2, col=spot_type)) +
  #     geom_point(size=0.1) +
  #     scale_color_manual("", values = col.set$spots) +
  #     labs(title = "Spatial representation of manual annotations") +
  #     theme_bw() +
  #     theme(aspect.ratio = 1,
  #           axis.title = element_blank(),
  #           axis.text.y = element_blank(),
  #           axis.ticks.y = element_blank(),
  #           axis.text.x = element_text(colour = "white"),
  #           axis.ticks.x = element_line(colour = "white"),
  #           legend.position = "none") +
  #     facet_wrap(.~sample,
  #                scales = "fixed", #space = "free_x",
  #                nrow = 2),
  #   ggplot(data=df,
  #          aes(x=spatial1, y=spatial2, col=leiden_r0.5_patient)) +
  #     geom_point(size=0.1) +
  #     scale_color_manual("", values = col.set$leiden_r0.5_patient) +
  #     labs(title = "Spatial representation of Leiden clusters") +
  #     theme_bw() +
  #     theme(aspect.ratio = 1,
  #           axis.title = element_blank(),
  #           axis.text.y = element_blank(),
  #           axis.ticks.y = element_blank(),
  #           axis.text.x = element_text(colour = "white"),
  #           axis.ticks.x = element_line(colour = "white"),
  #           legend.position = "none") +
  #     facet_wrap(.~sample,
  #                scales = "fixed",
  #                nrow = 2),
  #   nrow = 2, ncol = 1),
  # as_ggplot(get_legend(leiden0.5_bar_spot)),
  # nrow = 1, ncol = 3,
  # widths = c(2,3,0.7))
```

##Leiden 1.3
```{r, fig.width=30, fig.height=20}
leiden1.3_bar_spot <- 
  ggplot(data=df,
         aes(x=leiden_r1.3, fill=spot_type)) +
    geom_bar(stat="count", position = "fill") +
    scale_fill_manual("", values = col.set$spots) +
    labs(title = "Clusters by spot annotations") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

leiden1.3_bar_skin <-
  ggplot(data=df,
         aes(x=leiden_r1.3, fill=skin_layer)) +
    geom_bar(stat="count", position = "stack") +
    scale_fill_manual("", values = col.set$dermis) +
    labs(title = "Clusters by skin layers") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

leiden1.3_bar_biopsy <-
  ggplot(data=df,
       aes(x=leiden_r1.3, fill=biopsy_type)) +
    geom_bar(stat="count", position = "stack") +
    scale_fill_manual("", values = col.set$lesions) +
    labs(title = "Lesional or non-lesional spots") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

leiden1.3_bar_patient <-
  ggplot(data=df[df$GRANULOMA=="0", ],
         aes(x=leiden_r1.3, fill=patient)) +
    geom_bar(stat="count", position = "stack") +
    scale_fill_manual("", values = col.set$patients) +
    labs(title = "Donors for non-lesional spots") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

## BC ----
leiden1.3_BC_bar_spot <- 
  ggplot(data=df,
         aes(x=leiden_r1.3_patient, fill=spot_type)) +
    geom_bar(stat="count", position = "fill") +
    scale_fill_manual("", values = col.set$spots) +
    labs(title = "Clusters by spot annotations") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

leiden1.3_BC_bar_skin <-
  ggplot(data=df,
         aes(x=leiden_r1.3_patient, fill=skin_layer)) +
    geom_bar(stat="count", position = "stack") +
    scale_fill_manual("", values = col.set$dermis) +
    labs(title = "Clusters by skin layers") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

leiden1.3_BC_bar_biopsy <-
  ggplot(data=df,
       aes(x=leiden_r1.3_patient, fill=biopsy_type)) +
    geom_bar(stat="count", position = "stack") +
    scale_fill_manual("", values = col.set$lesions) +
    labs(title = "Lesional or non-lesional spots") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

leiden1.3_BC_bar_patient <-
  ggplot(data=df[df$GRANULOMA=="0", ],
         aes(x=leiden_r1.3_patient, fill=patient)) +
    geom_bar(stat="count", position = "stack") +
    scale_fill_manual("", values = col.set$patients) +
    labs(title = "Donors for non-lesional spots") +
    ylab('Proportion') +
    theme_bw() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
    coord_flip()

# Show no BC vs BC all plots
ggarrange(
  #ggarrange(
    as_ggplot(get_legend(leiden1.3_bar_spot)),
    #as_ggplot(get_legend(leiden1.3_bar_skin)),
    #nrow = 2, ncol = 1,
    #align = "hv"),
  leiden1.3_bar_spot + theme(legend.position = "none"),
  leiden1.3_bar_skin + theme(legend.position = "none"),
  leiden1.3_bar_biopsy + theme(legend.position = c(0.68,0.915)),
  leiden1.3_bar_patient + theme(legend.position = c(1.32,1.357)),
    #ggarrange(
    #as_ggplot(get_legend(leiden1.3_BC_bar_spot)),
    as_ggplot(get_legend(leiden1.3_BC_bar_skin)),
    #nrow = 2, ncol = 1,
    #align = "hv"),
  leiden1.3_BC_bar_spot + theme(legend.position = "none"),
  leiden1.3_BC_bar_skin + theme(legend.position = "none"),
  leiden1.3_BC_bar_biopsy + theme(legend.position = c(0.68,0.915)),
  leiden1.3_BC_bar_patient + theme(legend.position = c(1.32,1.357)),
  nrow = 2, ncol = 5, widths = c(1,1.5,1.5,1.5,1.5)
)

```
##Fractions and cluster size r1.3
```{r}
### Leiden legend
leiden_legend <- ggplot() +
  geom_point(aes(x=as.factor(seq(0:19)), y = rep(0,20), 
                 color = factor(as.character(seq(0, 19)),
                                ordered = TRUE,
                                levels = as.character(seq(0, 19))),
                 size = 10)) +
  scale_color_manual(values = col.set$leiden_r1.3) +
  labs(title = "Test") +
  theme_bw() + 
  coord_flip() +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "white")) +
  theme(legend.position = "none",
        axis.line.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(color="white"),
        axis.ticks.x = element_line(color="white"),
        axis.title = element_blank(),
        plot.title = element_text(colour = 'white')) +
  scale_x_discrete(limits=rev)
#leiden_legend

### Cluster size Leiden 1.3
clustersize_leiden13 <- ggplot(data=df,
                               aes(x=factor(paste0(leiden_r1.3_patient, "     "),
                                            ordered = TRUE,
                                            levels = as.character(paste0(0:19, "     "))),
                                   fill = leiden_r1.3_patient)) +
  geom_bar(stat="count", position = "stack") +
  scale_fill_manual("", values = col.set$leiden_r1.3) +
  labs(title = "Cluster size (spot count)") +
  theme_bw() +
  theme(axis.text.y = element_text(size = 15),
        axis.line.y = element_blank(),
        axis.title = element_blank()) +
  scale_x_discrete(limits=rev) +
  coord_flip() 
#clustersize_leiden13

### Cluster fractions Leiden 1.3
fractions_leiden13 <- ggplot(data=df,
                             aes(x=leiden_r1.3_patient,
                                 fill=spot_type)) +
  geom_bar(stat="count", position = "fill") +
  scale_fill_manual("", values = col.set$spots) +
  labs(title = "Spot type fraction per cluster") +
  theme_bw() +
  theme(axis.line.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title = element_blank()) +
  scale_x_discrete(limits=rev) +
  coord_flip() 
#fractions_leiden13

### Combination
clustersize_fraction <- ggarrange(
  leiden_legend,
  clustersize_leiden13,
  fractions_leiden13,
  common.legend = T, legend = "none",
  widths = c(1, 3.5, 3),
  nrow = 1, ncol = 3)
```

## Summary Leiden 1.3 
```{r, fig.width=30, fig.height=10}
# Leiden r1.3 clustering (details) ----
ggarrange(
  # Legends
  ggarrange(
    as_ggplot(get_legend(leiden1.3_BC_bar_skin)),
    as_ggplot(get_legend(leiden1.3_BC_bar_spot)),
    nrow = 2, ncol = 1),
  # Leiden clustering for r = 1.3 in UMAP
  UMAP_BC_leiden1.3 + geom_point(size = 2) +
    theme(legend.position = "none", axis.title = element_blank(), plot.title = element_text(hjust = 0.5, size = 20)) + 
    labs(title = "Leiden clustering (r = 1.3) UMAP visualization"), 
  # Barplots: spot annotations, cluster size, skin layers, lesional vs non lesional, donor (patient)
  leiden1.3_BC_bar_spot +
    labs(title = "Spot annotations", x = "Clusters") +
    theme(legend.position = "none", plot.title = element_text(hjust = 0.5, size = 15), axis.title.x = element_blank()),
  ggplot(data=df, aes(x=leiden_r1.3_patient, fill= leiden_r1.3_patient)) +
        geom_bar(stat="count", position = "stack") + #stack #fill
        scale_fill_manual("", values = col.set$leiden_r1.3) +
        labs(title = "Cluster size") +
        theme_bw() +
        theme(axis.line.y = element_blank(),
              axis.text.y = element_blank(),
              axis.ticks.y = element_blank(),
              axis.title = element_blank(),
              plot.title = element_text(hjust = 0.5, size = 15),
              legend.position = "none") +
        coord_flip(),
  leiden1.3_BC_bar_skin + 
      labs(title = "Skin layers") +
      theme(legend.position = "none",
            plot.title = element_text(hjust = 0.5, size = 15),
            axis.title = element_blank(),
            axis.line.y = element_blank(),
            axis.text.y = element_blank(),
            axis.ticks.y = element_blank()),
  leiden1.3_BC_bar_biopsy +
    labs(title = "Lesional or non-lesional spots") +
    theme(legend.position = c(0.68,0.915),
          plot.title = element_text(hjust = 0.5, size = 15),
          axis.title = element_blank(),
          axis.line.y = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank()),
  leiden1.3_BC_bar_patient +
    labs(title = "Donor (patient)") +
    theme(legend.position = c(0.82,0.857),
          plot.title = element_text(hjust = 0.5, size = 15),
          axis.title = element_blank(),
          axis.line.y = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank()),
  nrow = 1, ncol = 7, widths = c(1,3,1.5,1,1.5,1.5,1.5)
)
```


# Leiden spatial 
```{r, fig.width=18, fig.height=6}
# Spatial representation of Leiden clustering ----
leiden_spatial_plots <- ggplot(data=df,
           aes(x=spatial1, y=spatial2, col=leiden_r1.3_patient)) +
      geom_point(size=1) +
      scale_color_manual('', values = col.set$leiden_r1.3) +
      scale_y_reverse() +
      labs(title = "Spatial representation of Leiden clusters") +
      theme_bw() +
      theme(aspect.ratio = 1,
            axis.title = element_blank(),
            axis.text.y = element_blank(),
            axis.ticks.y = element_blank(),
            plot.background = element_rect(fill = NA, colour=NA),
            #strip.background=element_blank(),#element_rect(fill=NA, colour="black"),
            #strip.text = element_blank(),#element_text(colour = "black", size = 12), #face="bold"
            axis.text.x = element_blank(),
            axis.ticks.x = element_blank(),
            legend.position = "none") +
      facet_wrap(.~sample,
                 scales = "fixed",
                 nrow = 2)
# Spatial representation of manual annotations ----
manual_spatial_plots <- ggplot(data=df,
           aes(x=spatial1, y=spatial2, col=spot_type)) +
      geom_point(size=1) +
      scale_color_manual('', values = col.set$spots) +
      scale_y_reverse() +
      labs(title = "Spatial representation of manual annotations") +
      theme_bw() +
      theme(aspect.ratio = 1,
            axis.title = element_blank(),
            axis.text.y = element_blank(),
            axis.ticks.y = element_blank(),
            plot.background = element_rect(fill = NA, colour=NA),
            #strip.background=element_blank(),#element_rect(fill=NA, colour="black"),
            #strip.text = element_blank(),#element_text(colour = "black", size = 12), #face="bold"
            axis.text.x = element_blank(),
            axis.ticks.x = element_blank(),
            legend.position = "none") +
      facet_wrap(.~sample,
                 scales = "fixed",
                 nrow = 2)
# ggplot(data=df,
#            aes(x=spatial1, y=spatial2, col=spot_type)) +
#       geom_point(size=1) +
#       scale_color_manual("", values = col.set$spots) +
#       scale_x_reverse() +
#       labs(title = "Spatial representation of manual annotations") +
#       theme_bw() +
#       theme(aspect.ratio = 1,
#             axis.title = element_blank(),
#             axis.text.y = element_blank(),
#             axis.ticks.y = element_blank(),
#             plot.background = element_rect(fill = NA, colour=NA),
#             strip.background=element_blank(),#element_rect(fill=NA, colour="black"),
#             strip.text = element_blank(),#element_text(colour = "black", size = 12), #face="bold"
#             axis.text.x = element_text(colour = "white"),
#             axis.ticks.x = element_line(colour = "white"),
#             legend.position = "none") +
#       facet_wrap(.~sample,
#                  scales = "fixed",
#                  nrow = 2)
```
